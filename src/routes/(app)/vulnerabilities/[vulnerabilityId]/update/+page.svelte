<script lang="ts">
  import { goto, invalidateAll } from "$app/navigation";
  import { base } from "$app/paths";
  import { pb, useUser } from "$lib";
  import VulnerabilityEditor from "$lib/components/VulnerabilityEditor.svelte";
  import type { RecordModel } from "pocketbase";
  export let data;
  let vulnerability: Partial<RecordModel> = { ...data.vulnerability };
  let category: Partial<RecordModel> | null = vulnerability.category
    ? { id: vulnerability.category, name: vulnerability.category }
    : null;
  let incident: Partial<RecordModel> | null =
    vulnerability.expand?.incident || null;
  let newFiles: File[];
  let oldFiles: string[];
  let wordCount = 0;
  let loading = false;

  const user = useUser();

  $: toDelete = oldFiles?.length
    ? (vulnerability.attachments || []).filter(
        (f: string) => !(oldFiles || []).find((of) => of == f)
      )
    : vulnerability.attachments || [];
  $: console.log(toDelete);

  async function createVulnerability() {
    if (loading) return;
    const required = ["title", "severity", "status"];
    if (required.some((r) => !String(vulnerability[r] || "").trim())) {
      console.log(vulnerability, wordCount);
      alert("Debes llenar los campos obligatorios");
      return;
    }
    loading = true;
    try {
      const formData = new FormData();
      formData.append("author", $user!.id);
      formData.append("title", vulnerability.title);
      formData.append("description", vulnerability.description || "");
      formData.append("severity", vulnerability.severity);
      formData.append("category", category?.id || category?.name || "");
      formData.append("incident", incident?.id || "");
      formData.append("status", vulnerability.status);
      for (const [_, file] of newFiles.entries()) {
        formData.append("attachments", file);
      }
      const updated = await pb
        .collection("vulnerabilities")
        .update(vulnerability.id!, formData, {});
      await pb.collection("vulnerabilities").update(updated.id, {
        "attachments-": toDelete,
      });
      await invalidateAll();
      await goto(`${base}/vulnerabilities/${updated.id}`);
    } catch (err) {
      console.log(err);
      loading = false;
    }
  }

  async function del() {
    if (data.vulnerability.deleted) {
      await pb.collection("vulnerabilities").delete(vulnerability.id!);
    } else {
      await pb.collection("vulnerabilities").update(vulnerability.id!, {
        deleted: true,
      });
    }
    await invalidateAll();
    goto(`${base}/vulnerabilities`);
  }
</script>

<form
  class="flex flex-col space-y-8"
  on:submit={createVulnerability}
  class:pointer-events-none={loading}
>
  <div
    class="flex w-full justify-between lg:items-center <lg:(space-y-2 flex-col) lg:space-x-2"
  >
    <h1 class="text-xl font-bold">{data.title}</h1>
    <div class="flex space-x-2 items-center <lg:w-full">
      <button
        class="bg-blue-500 p2 rounded transition-200 hover:bg-blue-400 text-white flex items-center space-x-2 <lg:w-full items-center justify-center"
      >
        <un-i-carbon-upload />
        <span class="text-xs">Subir cambios</span>
      </button>
      {#if data.vulnerability.deleted && $user?.admin}
        <button
          class="bg-green-500 p2 rounded transition-200 hover:bg-green-400 text-white flex items-center space-x-2 <lg:w-full items-center justify-center"
          type="button"
          on:click={async () => {
            await pb
              .collection("vulnerabilities")
              .update(data.vulnerability.id || "", {
                deleted: false,
              });
            await invalidateAll();
          }}
        >
          <un-i-carbon-trash-can />
          <span class="text-xs">Restaurar</span>
        </button>
      {/if}
      <button
        class="bg-red-500 p2 rounded transition-200 hover:bg-red-400 text-white flex items-center space-x-2 <lg:w-full items-center justify-center"
        type="button"
        on:click={del}
      >
        <un-i-carbon-trash-can />
        <span class="text-xs"
          >{data.vulnerability.deleted
            ? "Eliminar permanentemente"
            : "Eliminar"}</span
        >
      </button>
    </div>
  </div>
  <VulnerabilityEditor
    bind:vulnerability
    bind:wordCount
    bind:category
    bind:incident
    bind:newAttachments={newFiles}
    bind:oldAttachments={oldFiles}
  />
</form>
