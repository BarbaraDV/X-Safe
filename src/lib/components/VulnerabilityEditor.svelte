<script lang="ts">
  import type { RecordModel } from "pocketbase";
  import RichEditor from "./RichEditor.svelte";
  import CategoryDropdown from "./CategoryDropdown.svelte";
  import UploadImages from "./UploadImages.svelte";
  import { onMount } from "svelte";

  export let vulnerability: Partial<RecordModel> = {};
  export let wordCount: number;
  export let newAttachments: File[] = [];
  export let oldAttachments: string[] = [];
  export let category: Partial<RecordModel> | null = null;
  export let incident: Partial<RecordModel> | null = null;

  let files: (File | string)[] = [];
  onMount(() => {
    files = [...(vulnerability.attachments || [])];
  });

  $: if (vulnerability.description === undefined) {
    vulnerability.description = "";
  }

  $: if (vulnerability.title === undefined) {
    vulnerability.title = "";
  }

  $: if (vulnerability.severity === undefined) {
    vulnerability.severity = "";
  }

  let internal: string = "";

  const input = (x: string) => {
    const date = new Date(x);
    internal = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;
  };
  const output = (x: string) => {
    try {
      const date = new Date(x);
      date.setDate(date.getDate() + 1);
      vulnerability.date = date.toUTCString();
    } catch (e) {
      console.log(e);
    }
  };

  $: input(vulnerability.date);
  $: output(internal);
</script>

<div class="flex flex-col space-y-4">
  <p class="text-xs">
    <strong>Nota:</strong> los campos marcados con asteriscos (*) son obligatorios
  </p>
  <div class="flex items-center <lg:(flex-col space-y-2) lg:space-x-2 w-full">
    <label class="flex flex-col space-y-2 w-full">
      <span class="text-xs font-bold">Título *</span>
      <input
        type="text"
        bind:value={vulnerability.title}
        class="p-2 rounded w-full flex border dark:bg-dark-700 dark:border-dark-50"
      />
    </label>
  </div>
  <div class="flex items-center <lg:(flex-col space-y-2) lg:space-x-2 w-full">
    <!-- svelte-ignore a11y-label-has-associated-control -->
    <label class="flex flex-col space-y-2 w-full">
      <span class="text-xs font-bold">Categoría</span>
      <CategoryDropdown collection="categories" bind:selected={category} />
    </label>
    <!-- svelte-ignore a11y-label-has-associated-control -->
    <label class="flex flex-col space-y-2 w-full">
      <span class="text-xs font-bold">Incidencia relacionada</span>
      <CategoryDropdown
        collection="incidents"
        entityName="incidencia"
        key="short_description"
        sort="date"
        crud={false}
        filter={(input) => `short_description ~ "${input}"`}
        placeholder="Busca una incidencia"
        bind:selected={incident}
        displayNameFn={(record) => {
          return `${new Date(record.date).toLocaleDateString()} - ${
            record.short_description
          }`;
        }}
      />
    </label>
  </div>
  <div class="flex items-center <lg:(flex-col space-y-2) lg:space-x-2 w-full">
    <label class="flex flex-col space-y-2 w-full">
      <span class="text-xs font-bold">Severidad *</span>
      <select
        class="p-2 rounded w-full flex border bg-white dark:bg-dark-700 dark:border-dark-50"
        bind:value={vulnerability.severity}
      >
        <option hidden value="">Selecciona la severidad</option>
        <option value="low">Baja</option>
        <option value="medium">Media</option>
        <option value="high">Alta</option>
        <option value="critic">Crítica</option>
      </select>
    </label>
    <label class="flex flex-col space-y-2 w-full">
      <span class="text-xs font-bold">Estado actual *</span>
      <select
        class="p-2 rounded w-full flex border bg-white dark:bg-dark-700 dark:border-dark-50"
        bind:value={vulnerability.status}
      >
        <option hidden value="">Selecciona el estado</option>
        <option value="pending">Pendiente</option>
        <option value="reviewing">En revisión</option>
        <option value="solved">Resuelto</option>
      </select>
    </label>
  </div>
  <!-- svelte-ignore a11y-label-has-associated-control -->
  <label class="flex flex-col space-y-2">
    <span class="text-xs font-bold">Descripción de la vulnerabilidad</span>
    <RichEditor bind:value={vulnerability.description} bind:wordCount />
  </label>
  <!-- svelte-ignore a11y-label-has-associated-control -->
  <div class="flex flex-col space-y-2">
    <span class="text-xs font-bold">Imágenes adjuntas</span>
    <UploadImages
      record={vulnerability}
      bind:files
      bind:newFiles={newAttachments}
      bind:oldFiles={oldAttachments}
    />
  </div>
</div>
